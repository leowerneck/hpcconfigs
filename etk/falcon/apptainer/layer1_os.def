# File: layer1_os.def
Bootstrap: docker
From: ubuntu:24.04

%help
    Einstein Toolkit Container --- Layer 1/5 --- Operating System

    This base layer bootstraps Ubuntu 24.04 and installs
    basic compilers, libraries, and build tools.

%labels
    Author(s)  Leo Werneck <wernecklr@gmail.com>
    Version    1.0
    Layer      1/5

%files
    ./clusters.yml /opt/clusters.yml
    ./parser.py /opt/cluster_parser.py

%post
    set -e

    # Create the environment file, so be sourced by every layer
    cat << 'EOF' > /env.sh
#!/bin/sh

# File: /env.sh
# Desc: contains environment variables used across multiple layers

# Locale
export LANGUAGE=en_US.UTF-8
export LANG=en_US.UTF-8
export LC_ALL=en_US.UTF-8

# Compilers
export CC=$(which gcc)
export CXX=$(which g++)
export FC=$(which gfortran)
export F77=$(which gfortran)
export F90=$(which gfortran)

# Resources repository
export RESOURCES_URL=https://github.com/leowerneck/apptainer_libs/raw/refs/heads/main

# Convenience functions
download_unpack_and_cd() {
    cd /
    curl -LO ${RESOURCES_URL}/$1.tar.gz
    tar xzvf $1.tar.gz
    cd /$1
}

clean() {
    cd / && rm -rf ${1}*
}

# Initialize Lmod
[ -f /etc/profile.d/lmod.sh ] && . /etc/profile.d/lmod.sh

# Modules path
export MODULES_ROOT=/opt/modulefiles
module use $MODULES_ROOT

# Export available cluster configurations
export SUPPORTED_CLUSTERS=$(find $MODULES_ROOT -type f -name '*.lua' -exec basename {} .lua \;)
EOF

    # Install all required system-level dependencies
    apt-get -y update && apt-get -y install --no-install-recommends \
        cmake             \
        curl              \
        gcc               \
        g++               \
        gfortran          \
        git               \
        ibverbs-providers \
        libhwloc-dev      \
        libibverbs-dev    \
        libnl-3-dev       \
        libnl-route-3-dev \
        librdmacm-dev     \
        libudev-dev       \
        libyaml-cpp-dev   \
        lmod              \
        locales           \
        make              \
        numactl           \
        patch             \
        perl              \
        pkg-config        \
        python-is-python3 \
        python3           \
        python3-pip       \
        python3-venv      \
        rdma-core         \
        rsync             \
        zlib1g-dev

    # Set up lmod
    echo '. /etc/profile.d/lmod.sh' > /etc/profile.d/zz-lmod.sh

    # Clean up apt cache to reduce image size
    rm -rf /var/lib/apt/lists/*

    # --- Locale Generation ---
    # Generate and configure the en_US.UTF-8 locale
    echo "en_US.UTF-8 UTF-8" >> /etc/locale.gen
    locale-gen
    update-locale LANG=en_US.UTF-8

    # Generate the modules
    . /env.sh
    mkdir $MODULES_ROOT
    python3 -m venv /opt/py3
    . /opt/py3/bin/activate
    pip install -U pip pyyaml
    python /opt/cluster_parser.py /opt/clusters.yml $MODULES_ROOT

    # Clean up the python virtual environment, as we will not need it anymore
    deactivate
    rm -rf /opt/py3

%test
    . /env.sh
    echo "Checking compilers and basic tools..."
    for tool in gcc g++ gfortran cmake python3 locale make pkg-config curl; do
        TOOL=$(which $tool)
        if [ $? -eq 0 ]; then
            echo "Success! Found $tool in $TOOL"
        else
            echo "Error! Could not find $tool"
            exit 1
        fi
    done

    if command -v module >/dev/null 2>&1; then
        echo "Success! 'module' is available"
    else
        echo "Error! 'module' command not found"; exit 1
    fi
