# File: layer3_mpi.def
Bootstrap: localimage
From: layer2_ucx.sif

%help
    Einstein Toolkit Container --- Layer 3/5 --- MPI

    This layer installs MPI for Falcon, specifically OpenMPI. You will
    find the installation at FALCON_ROOT.

%labels
    Author(s)  Leo Werneck <wernecklr@gmail.com>
    Version    1.0
    Layer      3/5

%post
    set -e
    cat << 'EOF' >> /env.sh

# MPI
export FALCON_MPI_FLAVOR=openmpi
export FALCON_MPI_VERSION=4.1.6
EOF

    # Load the updated environment
    . /env.sh

    cd /
    download_unpack_and_cd ${FALCON_MPI_FLAVOR}-${FALCON_MPI_VERSION}

    ./configure                   \
        --prefix=${FALCON_ROOT}   \
        --with-ucx=${FALCON_ROOT} \
        --with-verbs              \
        --with-hwloc=/usr         \
        --without-hwloc-internal
    make -j8 && make install

    clean ${FALCON_MPI_FLAVOR}-${FALCON_MPI_VERSION}

%test
    echo "Testing mpi install"
    for tool in \
            ${FALCON_BIN}/mpicc   \
            ${FALCON_BIN}/mpicxx  \
            ${FALCON_BIN}/mpifort \
            mpicc mpicxx mpifort; do

        if TOOL=$(command -v "$tool" 2>/dev/null); then
            echo "Success! Found $tool in $TOOL"
        else
            echo "Error! Could not find $tool"
            exit 1
        fi

    done

    printf "Testing if pkg-config can find ompi: "
    if ! pkg-config --exists ompi; then
        echo "no!"
        echo "Error: pkg-config cannot find OpenMPI"
        exit 1
    fi
    echo "yes!"

%environment
    . /env.sh
