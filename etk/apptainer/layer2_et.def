# File: layer2_et.def
Bootstrap: localimage
From: layer1_os.sif

%help
    This container holds a compiled installation of the Einstein Toolkit.
    To use, start an interactive shell with: apptainer shell <image_name>.sif

%setup
    touch ${SINGULARITY_ROOTFS}/input_thornlist.th

%post
    # Move to a known directory
    cd /

    # Download GetComponents using instructions from einsteintoolkit.org
    curl -kLO "https://raw.githubusercontent.com/gridaphobe/CRL/ET_2025_05/GetComponents"
    chmod a+x GetComponents

    # Download the Einstein Toolkit using the shortened bns.th thornlist
    # Note: The path to bns.th is now in the root of the container
    ./GetComponents --noshallow /input_thornlist.th --root /Cactus

    # Now build the Einstein Toolkit.
    cd /Cactus
    yes | make sim-config
    cp thornlists/input_thornlist.th configs/sim/ThornList
    make -j16

    # Copy the executable
    cp exe/cactus_sim /et_exe

    # Clean up
    cd /
    rm -rf Cactus

%runscript
    # This script runs when you execute the container (e.g., ./et_<parfile>.sif)
    echo "Einstein Toolkit container ready. Running the Einstein Toolkit."
    /et_exe "$@"
