# File: layer3_mpi.def
Bootstrap: localimage
From: layer2_ucx.sif

%help
    Einstein Toolkit Container --- Layer 2/3 --- MPI

%labels
    Author(s) Leo Werneck <wernecklr@gmail.com>
    Version   1.0

%post
    set -e

    ###################
    # OpenMPI Version #
    ###################
    OMPI_VERSION=4.1.6

    # Additional versioning, required for download OpenMPI
    OMPI_MAJOR_VERSION=$(echo "$OMPI_VERSION" | cut -d. -f1,2)
    OMPI_MINOR_VERSION=$(echo "$OMPI_VERSION" | cut -d. -f3)

    ###################
    # OpenMPI Install #
    ###################
    export OMPI_ROOT=/opt/openmpi-${OMPI_VERSION}

    cd /
    curl -OL https://download.open-mpi.org/release/open-mpi/v${OMPI_MAJOR_VERSION}/openmpi-${OMPI_VERSION}.tar.gz
    tar xzvf openmpi-${OMPI_VERSION}.tar.gz
    cd openmpi-${OMPI_VERSION}

    ./configure               \
        --prefix=${OMPI_ROOT} \
        --with-ucx=/opt/ucx   \
        --with-verbs          \
        --with-hwloc=/usr     \
        --without-hwloc-internal
    make -j8 && make install

    cd / && rm -rf openmpi-${OMPI_VERSION}*

    # Convenient symlink
    ln -s /opt/openmpi-${OMPI_VERSION} /opt/openmpi

%environment
    export OMPI_VERSION=4.1.6
    export OMPI_ROOT=/opt/openmpi
    export PATH=${OMPI_ROOT}/bin:$PATH
    export LD_LIBRARY_PATH=${OMPI_ROOT}/lib:$LD_LIBRARY_PATH
    export MANPATH=${OMPI_ROOT}/share/man:$MANPATH
